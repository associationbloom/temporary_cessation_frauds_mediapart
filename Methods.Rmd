---
title: "Analysis of COVID temporary cessation payments allocated to the Dutch fleet"
subtitle: "Detailed methodology"
author: "Augustin Lafond, Laetitia Bisiaux and Frédéric Le Manach"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    fig_caption: yes
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
always_allow_html: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, dpi = 300)
```

```{r, include = FALSE, message = FALSE, results = FALSE, echo = FALSE, warning = FALSE}
#Load necessary scripts
source("Scripts/Functions/load_packages.R") #Load packages
source("Scripts/Others/plot_themes.R") #Load plot themes

#Create function to stylize tables
table <- function(df, caption) {
  options(knitr.kable.NA = "")
  df %>%
    kbl(caption = caption) %>%
    kable_paper(full_width = TRUE) %>%
    kable_styling(bootstrap_options = c("striped", "condensed", "responsive", "hover")) %>%
    row_spec(0, bold = TRUE) %>%
    collapse_rows(columns = 1:1, valign = "top") %>%
    scroll_box(width = "100%")
}
```

# Making the database

## The European fleet register

The EU fleet register (<https://webgate.ec.europa.eu/fleet-europa/search_en>) --- which contains all historical records relating to fishing vessels flagged in EU Member States --- was downloaded on 17 December 2021 with the following filters:

- Country: 'EU'  
- Period: 'All vessels'  
- Search data context: 'Search data in the whole history of the vessels'

The downloaded file was then processed. The first step was to load it:

```{r}

fleet <- read.csv2("https://www.dropbox.com/s/3xc7t2o76ccudqe/vesselRegistryListResults-2021_12_17.csv?dl=1", quote = "", stringsAsFactors = FALSE) 

```

### Fixing incorrect records

We then proceeded with cleaning the fleet's data. The first step was to fix the Register's exported file, which contained `r nrow(fleet %>% filter(LOA == ""))` rows that did not tabulate correctly:

```{r, message = FALSE}
fleet <- fleet %>%
  filter(!LOA == "" & !Country.of.Registration == "\"\"") %>% #Set aside correct records
  bind_rows(fleet %>% #Deal with incorrect records (duplicate rows that incorrectly tabulated)
              filter(Country.of.Registration == "\"\"") %>% #Set aside first part of duplicate records
              select(c(Event:Power.of.main.engine)) %>%
              rename_at(vars(colnames(fleet %>% #Rename columns based on correct records
                                        filter(Country.of.Registration == "\"\"") %>%
                                        select(c(Event:Power.of.main.engine)))), 
                        ~ colnames(fleet %>%
                                     select(c(IRCS.indicator:ncol(.))))) %>%
              bind_cols(fleet %>% #Bind fixed duplicates with other part of duplicate records
                          filter(LOA == "") %>%
                          select(c(1:Name.of.vessel))) %>%
              mutate(Place.of.registration = "",
                     IRCS = "",
                     Hull.material = as.integer(Hull.material)))
```

### Cleaning records

First, we selected the columns of interest and renamed them:

```{r}
fleet <- fleet %>%
  select(country = Country.of.Registration, #Keep columns of interest and rename them
         cfr = CFR, 
         external_marking = External.marking,
         vessel_name = Name.of.vessel, 
         event_start_date = Event.Start.Date, 
         event_end_date = Event.End.Date, 
         gear_code = Main.fishing.gear,
         length = LOA,
         power = Power.of.main.engine)
```

We then transformed a few columns:

```{r}
fleet <- fleet %>%
  mutate(across(where(is.character), str_trim), #Remove all trailing and leading whitespace
         external_marking = str_remove_all(external_marking, c("\\\"|\\\r|\\\n|\\*|/UFA| ?|-?")), #Remove these patterns
         external_marking = str_replace(external_marking, "^([a-zA-Z]+)(0|-)([0-9]+)$", "\\1\\3"), #Further clean external_marking
         vessel_name = str_to_upper(str_replace(vessel_name, "-", " ")), #Capitalize vessel_name
         vessel_name = str_replace(vessel_name, "  ", " "), #Remove double spaces
         event_start_date = as.Date(event_start_date, origin = "1899-12-30"), #Make dates actual dates
         event_end_date = as.Date(ifelse(event_end_date == "2100-12-31", "2021-04-19", event_end_date), origin = "1899-12-30"), #Replace last records by download date and make dates actual dates
         length = as.numeric(length)) %>% #Convert as numeric
  distinct()
```

We then added a `gear` based on `gear_code`:

```{r}
fleet <- fleet %>%
  left_join(read.xlsx("https://www.dropbox.com/s/57dqlccmu1i8r99/MDR_Gear_Type.xlsx?dl=1") %>% #Downloaded on the European Commission's CIRCABC platform
              select(gear_code = Code,
                     gear = EnDescription,
                     gear_cat = SubCategory) %>%
              #Cleaning gear and gear_cat
              mutate(gear = str_to_sentence(str_remove(gear, "- ")),
                     gear = ifelse(grepl("know", ignore.case = TRUE, gear), "Unknown gear", gear),
                     gear_cat = ifelse(grepl("mid", ignore.case = TRUE, gear_cat), "Pelagic trawls & seines",
                                       ifelse(grepl("bottom", ignore.case = TRUE, gear_cat), "Bottom trawls & dredges",
                                              ifelse(grepl("surround", ignore.case = TRUE, gear), "Pelagic trawls & seines", 
                                                     ifelse(grepl("gill|trammel", ignore.case = TRUE, gear), "Entangling nets", 
                                                            ifelse(grepl("long", ignore.case = TRUE, gear), "Longlines", 
                                                                   ifelse(grepl("line", ignore.case = TRUE, gear), "Hook & lines", 
                                                                          ifelse(grepl("hand|beach", ignore.case = TRUE, gear), "Other gears",  
                                                                                 ifelse(grepl("dredge", ignore.case = TRUE, gear), "Bottom trawls & dredges",  
                                                                                        ifelse(grepl("bottom|danish|scottish", ignore.case = TRUE, gear), "Bottom trawls & dredges",  
                                                                                               ifelse(grepl("trawl", ignore.case = TRUE, gear), "Undet. trawls",  
                                                                                                      ifelse(grepl("pot|trap|pound|fyke|weir", ignore.case = TRUE, gear), "Pots & traps",  
                                                                                                             ifelse(grepl("purse|seine", ignore.case = TRUE, gear) & !grepl("PS", gear_code), "Pelagic trawls & seines",  
                                                                                                                    ifelse(grepl("PS", ignore.case = TRUE, gear_code), "Purse seines",  
                                                                                                                           ifelse(grepl("unknown", ignore.case = TRUE, gear), "Undet.", "Other gears"))))))))))))))) %>%
              #Adding missing gears
              add_row(gear_code = c("", "FDV", "GES", "HMS", "LVS", "NS", "SDV", "OTS", "000"), 
                      gear = c("Unknown gear", "Free diving", "Undet. nets", "Undet. dredges", "Set vertical lines", "Unknown gear", "Undet. bottom seines", "Undet. twin trawls", "Unknown gear"), 
                      gear_cat = c("Undet.", "Other gears", "Entangling nets ", "Bottom trawls & dredges", "Hook & lines", "Undet.", "Bottom trawls & dredges", "Undet. trawls", "Undet.")),
            by = "gear_code") %>%
  select(-gear_code)
```

Finally, we simplified the records:

```{r}
fleet <- setDT(fleet)
fleet <- fleet[,.(event_start_date = min(event_start_date),
                  event_end_date = max(event_end_date)) ,
               by = .(rleid(country, cfr, external_marking, vessel_name, gear, gear_cat, length, power),
                      country, 
                      cfr,
                      external_marking,
                      vessel_name,
                      gear,
                      gear_cat,
                      length, power)] %>%
  select(-rleid) %>%
  filter(!event_end_date < "2014-01-01")
```

## The European Fisheries & Maritime Fund (EMFF)

The EMFF list of beneficiaries was downloaded from the Netherlands Enterprise Agency's (RVO) website (<https://www.rvo.nl/onderwerpen/agrarisch-ondernemen/visserij-en-aquacultuur/europees-fonds-voor-maritieme-zaken-en-visserij-efmzv/openbaarmaking-efmzv-subsidies>) and loaded:

```{r}
emff <- read.xlsx("https://www.dropbox.com/s/ad6vbab7zqgkhck/T%C3%A9l%C3%A9charg%C3%A9%20le%2010-11-2021-Openbaarmaking_EFMZV_oktober_2021.xlsx?dl=1")
```

We then selected and renamed the columns of interest:

```{r}
emff <- emff %>% 
  select(beneficiary = Naam.van.de.begunstigde,
         cfr = Community.Fleet.Registry.identificatienummer,
         project_name = Naam.van.de.concrete.actie,
         project_description = Samenvatting.van.de.concrete.actie,
         project_start = Begindatum.van.de.concrete.actie,
         project_end = Einddatum.van.de.concrete.actie,
         payment_date = `Datum.subsidie-vaststellingen`,
         subsidy_total = Totale.subsidiabele.uitgaven,
         subsidy_eu = Bedrag.van.de.bijdrage.van.de.Unie,
         zip_code = Postcode.van.de.concrete.actie,
         eu_priority = Vermelding.van.de.betrokken.Unieprioriteit)
```

We then modified a few columns:

```{r}
emff <- emff %>%
  mutate(across(where(is.character), str_trim), #Remove all trailing and leading whitespace
         across(contains(c("start", "end", "date")), ~as.Date(as.character(.), format = "%Y%m%d")),
         eu_priority = case_when(eu_priority == "UP1" ~ "Fisheries",
                                 eu_priority == "UP2" ~ "Aquaculture",
                                 eu_priority == "UP3" ~ "Common Fisheries Policy",
                                 eu_priority == "UP4" ~ "Community-led local development strategies",
                                 eu_priority == "UP5" ~ "Marketing and processing",
                                 eu_priority == "UP6" ~ "Integrated Maritime Policy"))
```

We set aside all records pertaining to COVID-19:

```{r}
emff_covid <- emff %>% 
  filter_all(any_vars(grepl("stilliggen", ., ignore.case = TRUE) & grepl("covid", ., ignore.case = TRUE))) # 'Stilliggen' is Dutch for 'cessation'
```

At that stage, `r nrow(emff_covid)` rows out of the `r nrow(emff)` rows of the EMFF list of beneficiaries --- i.e. `r round((nrow(emff_covid) / nrow(emff)) *100, 1)` % --- were set aside and corresponded to COVID temporary cessation payments. In value, this `r nrow(emff_covid)` accounted for `r format(emff_covid %>% summarise(total = sum(subsidy_total)), big.mark = ",")` EUR, i.e. `r round((emff_covid %>% summarise(total = sum(subsidy_total)) / emff %>% summarise(total = sum(subsidy_total))) * 100, 1)` % of the entire EMFF allocated, and `r round((emff_covid %>% summarise(total = sum(subsidy_total)) / emff %>% filter(eu_priority == "Fisheries") %>% summarise(total = sum(subsidy_total))) * 100, 1)` % of Priority #1.

## Matching records

We then matched EMFF records with the Register:

```{r}

emff_covid <- emff_covid %>% 
  mutate (id = 1:n()) %>%
  left_join(fleet,
            by = "cfr") %>%
  rowwise() %>%
  mutate(ndays = pmax(pmin(project_end, event_end_date) - pmax(project_start, event_start_date) + 1,0)) %>% #Calculate interval overlap and set to 0 if no overlap
  with_groups(id, filter, ndays == max(ndays)) %>% #Keep most overlapping records
  distinct() 
  
# Case where there is no overlapping periods between our dataset and the fleet register 

if (emff_covid %>% filter (ndays == 0) %>% nrow () > 0) { 
  
emff_covid <- emff_covid %>% 
  filter (ndays > 0) %>%
  bind_rows(emff_covid %>%
              filter(ndays == 0) %>% 
              mutate (ndays = abs(pmin(project_end, event_end_date) - pmax(project_start, event_start_date) + 1)) %>%
              with_groups(id, filter, ndays == min(ndays)))
}

# Case where there is two or more exact same overlapping for a given CFR, e.g., one record of our dataset corresponding to one CFR has the same number of overlapping days with two or more records in the fleet register. This is a problem because it duplicates the record of our dataset. 

if (emff_covid %>% with_groups(id, mutate, count = n()) %>% filter (count > 1) %>% nrow () > 0) {

  emff_covid <- emff_covid %>% 
    with_groups(id, mutate, count = n()) %>% 
    filter (count == 1) %>% 
    bind_rows(emff_covid %>% 
    with_groups(id, mutate, count = n()) %>% 
    filter (count > 1) %>% 
    with_groups(id, slice, 1))
}

emff_covid <- emff_covid %>%
  select (-c("event_start_date", "event_end_date", "ndays", "count", "id"))

```

We remove from the list of subsidized vessels, the two vessels HK86-MARKERWAARD (CFR : NLD198701037) and WR226- JACK CORNELIS (CFR : NLD199001078) because for unknown reasons they share the same MMSI (244820038).

```{r}

emff_covid <- emff_covid %>%
  filter(!external_marking %in% c("WR226", "HK86"))
  
```

Following the ducth regultation n° WJZ/20087172 (https://zoek.officielebekendmakingen.nl/stcrt-2020-25324.html) giving the amount of COVID-19 temporary cessation subsidies that a vessel can perceived given its characteristics, we can calculate the number of weeks subsidized for each vessel based on the power of their main engine and the total amount of subsidy perceived.

```{r}

emff_covid <- emff_covid %>%
  mutate (power = as.numeric(power), 
          week_subsidy = ifelse(power*1.34102209 < 260, subsidy_total/2200, # 1.34102209 is the conversion factor from kW to cv
          ifelse(power*1.34102209>260 & power*1.34102209<300, subsidy_total/4400, 
                 ifelse(power*1.34102209>300, subsidy_total/8800, NA))))

```

# Results

## Culprit vessels

Following the ducth regultation n° WJZ/20087172 (https://zoek.officielebekendmakingen.nl/stcrt-2020-25324.html) about the COVID-19 temporary cessation subsidies, subsidized vessels have to :

1) Stop their fishing activity during 7 consecutive days per subsidized week, from 12:00 a.m. on the first day to 11:59 p.m. on the seventh day. 

2) Switch on their tracking system (AIS) during the whole temporary cessation period.

Vessels can be subsidized for up to 5 weeks, meaning they have to stop their fishing activity for 5 x 7 consecutive days and prove they stayed at the port thanks to their tracking system.

### The global fishing watch data

To verify that the subsidized vessels have respected these two conditions, we manually extracted on global fishing watch the fishing days as well as the days when the AIS was switched off.  

```{r}

# Let's load the GFW data

gfw_data <- read.xlsx("Data/Processed/GFW_data.xlsx") %>% 
    mutate_at(vars(c("project_start", "project_end", "fishing_start_gfw", "fishing_end_gfw", "ais_off_begin_gfw", "ais_off_end_gfw")), ~as.Date(., origin = "1899-12-30")) %>%
  select (-data_acquisition, -access, -cfr, -mmsi, -vessel_name, -last_check) %>% 
  mutate(fishing_period = interval(fishing_start_gfw, fishing_end_gfw)) %>%
  mutate(ais_off_period = interval(ais_off_begin_gfw, ais_off_end_gfw)) %>%
  select (-c("fishing_start_gfw", "fishing_end_gfw", "ais_off_begin_gfw", "ais_off_end_gfw")) %>% 
  pivot_longer(cols = c("fishing_period", "ais_off_period"), names_to = "action", values_to = "time_period") %>% 
  arrange(external_marking, time_period) %>% 
  filter(!is.na(time_period))

vessel_not_found <- read.xlsx("Data/Processed/GFW_data.xlsx") %>%
  filter (grepl("Not found",access)) %>%
  select (external_marking)

```

Then, we want to know which vessel switched off its AIS at least once during the temporary cessation period. 

```{r}

emff_covid <- emff_covid %>%
  left_join(gfw_data %>%
  filter(action == "ais_off_period") %>%
  select (external_marking) %>% 
  distinct() %>%
  mutate (culprit_ais_off = "TRUE"), by = "external_marking") %>%
  mutate (culprit_ais_off = ifelse(is.na(culprit_ais_off) & !external_marking %in% c(vessel_not_found %>% pull ()), "FALSE", culprit_ais_off))

```

Among the `r nrow(emff_covid)` vessels that received subsidies, `r nrow(emff_covid %>% filter(culprit_ais_off == "TRUE"))` switched off at least once their AIS during the temporary cessation period, and `r nrow(emff_covid %>% filter(culprit_ais_off == "FALSE"))` did not switch off their AIS. The remaining `r nrow(emff_covid %>% filter(is.na(culprit_ais_off)))` vessels were not found in GFW. 

The following list indicates the name of the `r nrow(emff_covid %>% filter(is.na(culprit_ais_off)))` vessels that received TC subsidies but that we could not find in GFW. 

```{r}

table(emff_covid %>% 
        filter (is.na(culprit_ais_off)) %>% 
        select(external_marking, cfr, vessel_name), "List of vessels that received TC subsidies but that we could not find in GFW")

```

We remove those vessels from the following analyses.

```{r}

emff_covid <- emff_covid %>%
  filter (!is.na(culprit_ais_off))

```

In addition, we remove from the following analyses `r nrow(emff_covid %>% filter (length<15))` vessels whose length is between 12-15 m, because according to the European Regulation 1224/2009 (https://eur-lex.europa.eu/LexUriServ/LexUriServ.do?uri=OJ:L:2009:343:0001:0050:fr:PDF), they don't have to own an AIS system. 

```{r}

emff_covid <- emff_covid %>%
  filter (length >= 15)

```

Hence the following analyses focus on the `r nrow(emff_covid)` subsidized vessels that were identified on GFW and whose length is higher than 15 m. 

We then plot the distribution of TC subsidies between vessel size class and gear 

```{r}

 ggplot(emff_covid %>% 
         mutate(class_length = ifelse(length < 12, "<12 m", 
                                      ifelse(length >= 12 & length < 25, "12-25 m", #Official FranceAgriMer classification
                                             ifelse(length >= 25 & length < 40, "25-40 m", ">40 m")))) %>%
         mutate(gear = ifelse(gear %in% c("Scottish seines", "Danish seines", "Pair seines"), "Senne démersale",
                              ifelse(gear %in% c("Single boat bottom otter trawls", "Twin bottom otter trawls"), "Chalut à panneaux",
                                     ifelse(gear == "Beam trawls", "Chalut à perche",
                                            ifelse(gear == "Pots", "Casier",
                                                   ifelse(gear == "Set gillnets (anchored)", "Filet maillant", gear)))))) %>%
         group_by(class_length, gear) %>%
         summarise(subsidy = sum(subsidy_total), subsidy = subsidy/10^6,
                   label = n(),
                   label = ifelse(label < 5, "", as.character(label))) %>%
         ungroup() %>%
         add_row (class_length = "<12 m", gear = "Chalut à perche", subsidy = 0, label = "") %>% # we add a row for the <12 m size class, since it did not received any subsidies. 
         mutate(class_length = factor (class_length, levels = c("<12 m", "12-25 m", "25-40 m", ">40 m")),
                gear = factor(gear, levels = c("Chalut à perche", "Chalut à panneaux", "Senne démersale", "Casier", "Filet maillant"))), aes(x=class_length, y=subsidy, fill = gear)) +
  geom_col (color = "grey0") +
  geom_text (aes(label = label), fontface = "bold", color = "grey100", position = position_stack(vjust = .5)) +
  labs (x="Classe de taille des navires", y ="Montant perçu (million EUR)", title = "Répartition des subventions allouées aux navires de pêche dans le cadre des arrêts temporaires", fill = "Engin de pêche") + 
  theme_bw () %+% 
  theme(plot.caption= element_text(hjust = 0)) +
  scale_fill_viridis_d () 


ggsave(last_plot(), file = "Output/Figures/Subsidies received for temporary cessation.png", width = 30, height = 15, unit = "cm")

```

We then calculate the fraction of the temporary cessation period during which vessels switched off their AIS. 

```{r}

emff_covid <- emff_covid %>%
  left_join(gfw_data %>%
  filter(action == "ais_off_period") %>%
  mutate(ais_off_days = as.numeric(as.Date(int_end(time_period)) - as.Date(int_start(time_period))) + 1) %>% # we add one to get the two extremities of the time interval
  group_by(external_marking, project_start, project_end) %>%
  summarise (ais_off_days = sum(ais_off_days)) %>%
  ungroup () %>%
  mutate (tc_days = as.numeric(project_end - project_start) + 1,
          ais_off_perc = round(ais_off_days * 100 / tc_days,1)) %>% 
    select(external_marking, ais_off_perc), by = "external_marking") %>%
    mutate(ais_off_perc = ifelse(is.na(ais_off_perc) & !external_marking %in% c(vessel_not_found %>% pull ()), 0, ais_off_perc))
    
```

We then determine if the subsidized vessels stopped their fishing activity during 7 consecutive days per subsidized week. Since we focus on the number of days spent without fishing and with the AIS on instead of the number of days at the port, this method is conservative. Indeed, we consider a days spent at sea without fishing the same as if the vessel remained docked, whereas the ducth regultation n° WJZ/20087172 indicates that the subsidized vessel have to prove it remain docked. 

The following analysis aims to look for vessels that can prove they stopped their fishing activity during 7 consecutive days per subsidized week, although their AIS was switched off intermittently.

```{r}

# cessation_begin contains the number of days for the first full period spent without fishing and with the AIS switched on 

cessation_begin <- gfw_data %>% 
  group_by(external_marking) %>% 
  slice(1) %>% 
  ungroup () %>% 
  mutate(cessation_days = as.numeric(as.Date(int_start(time_period)) - project_start)) %>% 
  select(external_marking, cessation_days)

# cessation_end contains the number of days for the last full period spent without fishing and with the AIS switched on 

cessation_end <- gfw_data %>% 
  arrange(external_marking, desc(time_period)) %>% 
  group_by(external_marking) %>% 
  slice(1) %>% 
  ungroup () %>% 
  mutate(cessation_days = as.numeric(project_end - as.Date(int_end(time_period)))) %>%
  select(external_marking, cessation_days)

# cessation_weeks contains the number of full weeks (i.e. 7 consecutive days) spent without fishing and with the AIS on.

cessation_weeks <- gfw_data %>% 
  mutate (cessation_days = as.numeric(as.Date(int_start(lead(time_period))) - as.Date(int_end(time_period)))-1) %>% # we calculate between each successive period, the number of days spent without fishing and with the AIS on
  group_by(external_marking) %>% 
  slice(-n()) %>% # we remove the last row because because there is n-1 periods of time between n successive time intervals
  ungroup () %>% 
  select(external_marking, cessation_days) %>% 
  bind_rows (cessation_begin) %>% # we add the number of days of the first full period spent without fishing and with the AIS switched on
  bind_rows (cessation_end) %>% # we add the number of days of the last full period spent without fishing and with the AIS switched on 
  arrange(external_marking) %>%
  mutate(cessation_weeks = floor(cessation_days/7)) %>% # we convert days into weeks. As we are only interest by full weeks (i.e., 7 consecutive days), we round to the lower integer. 
  group_by(external_marking) %>%
  summarise(cessation_weeks = sum(cessation_weeks)) %>% # we calculate the sum of weeks spent without fishing and with the AIS on
  ungroup ()

# we create a new column (culprit_seven_days_gfw) in emff_covid that indicates if vessels can prove thanks to their AIS if they have stopped their fishing activity during 7 consecutive days per subsidized week. 

emff_covid <- emff_covid %>%
  left_join(cessation_weeks, by = "external_marking") %>%
  mutate (culprit_7days_gfw = ifelse(cessation_weeks >= week_subsidy, "FALSE", "UNKNOWN")) %>%
  select(-cessation_weeks)

rm(cessation_begin, cessation_end, cessation_weeks, vessel_not_found)

```

Based on GFW data, we identified `r emff_covid %>% filter (culprit_7days_gfw == "FALSE") %>% select (external_marking) %>% distinct () %>% nrow ()` vessels which stopped their fishing activity during 7 consecutive days per subsidized week. Among those vessels `r emff_covid %>% filter (culprit_7days_gfw == "FALSE" & ais_off_perc > 0) %>% select (external_marking) %>% distinct () %>% nrow ()` switched off their AIS intermittently, while `r emff_covid %>% filter (culprit_7days_gfw == "FALSE" & ais_off_perc == 0) %>% select (external_marking) %>% distinct () %>% nrow ()` vessels had their AIS switched on during the whole temporary cessation period.

Then, we focus on the number of days between each fishing period (while in the previous analysis we focused on the number of days without fishing AND with the AIS on).

Even if the AIS record is incomplete, if the number of full weeks between each fishing period is lower than the number of week subsidized, it means that the vessel did not respect the TC rule, since even in the hypothetical case where an AIS off means the vessel is docked, there is not enough full weeks between the fishing periods to exonerate the vessel. 

```{r}

# This chunk is similar to the previous one. The difference is that we filter gfw_data to focus only on full weeks between fishing periods (we don't take into account the AIS off periods)

# cessation_begin contains the number of days for the first full period spent without fishing 

cessation_begin <- gfw_data %>% 
  filter (action == "fishing_period") %>%
  group_by(external_marking) %>% 
  slice(1) %>% 
  ungroup () %>% 
  mutate(cessation_days = as.numeric(as.Date(int_start(time_period)) - project_start)) %>% 
  select(external_marking, cessation_days)

# cessation_end contains the number of days for the last full period spent without fishing 

cessation_end <- gfw_data %>% 
  filter (action == "fishing_period") %>%
  arrange(external_marking, desc(time_period)) %>% 
  group_by(external_marking) %>% 
  slice(1) %>% 
  ungroup () %>% 
  mutate(cessation_days = as.numeric(project_end - as.Date(int_end(time_period)))) %>%
  select(external_marking, cessation_days)

# cessation_weeks contains the number of full weeks (i.e. 7 consecutive days) spent without fishing 

cessation_weeks <- gfw_data %>% 
  filter (action == "fishing_period") %>%
  mutate (cessation_days = as.numeric(as.Date(int_start(lead(time_period))) - as.Date(int_end(time_period)))-1) %>% # we calculate between each successive period, the number of days spent without fishing 
  group_by(external_marking) %>% 
  slice(-n()) %>% # we remove the last row because because there is n-1 periods of time between n successive time intervals
  ungroup () %>% 
  select(external_marking, cessation_days) %>% 
  bind_rows (cessation_begin) %>% # we add the number of days of the first full period spent without fishing 
  bind_rows (cessation_end) %>% # we add the number of days of the last full period spent without fishing 
  arrange(external_marking) %>%
  mutate(cessation_weeks = floor(cessation_days/7)) %>% # we convert days into weeks. As we are only interest by full weeks (i.e., 7 consecutive days), we round to the lower integer. 
  group_by(external_marking) %>%
  summarise(cessation_weeks = sum(cessation_weeks)) %>% # we calculate the sum of weeks spent without fishing 
  ungroup ()

# we add the TRUE category to culprit_7days_gfw which contains the vessels we identified as culprit 

emff_covid <- emff_covid %>%
  left_join(cessation_weeks, by = "external_marking") %>%
  mutate (culprit_7days_gfw = ifelse(cessation_weeks < week_subsidy & !is.na(cessation_weeks), "TRUE", culprit_7days_gfw)) %>% 
  select(-cessation_weeks)

rm(cessation_begin, cessation_end, cessation_weeks)

```
Based on GFW data, we identified, `r emff_covid %>% filter (culprit_7days_gfw == "TRUE") %>% select (external_marking) %>% distinct () %>% nrow ()` vessels which did not stop their fishing activity during 7 consecutive days per subsidized week. Among those vessels `r emff_covid %>% filter (culprit_7days_gfw == "TRUE" & ais_off_perc > 0) %>% select (external_marking) %>% distinct () %>% nrow ()` switched off their AIS intermittently, while `r emff_covid %>% filter (culprit_7days_gfw == "TRUE" & ais_off_perc == 0) %>% select (external_marking) %>% distinct () %>% nrow ()` vessels had their AIS switched on during the whole temporary cessation period. 

### The fish auction data (PEFA)

Data aggregated daily from the PEFA fish auctions website were loaded:

```{r}
pefa <- read.xlsx("Data/Raw/data_pefa.xlsx", sheet = "TOTAL")
```

We then renamed the columns of interest:

```{r}
pefa <- pefa %>% 
  select(date = Date,
         external_marking = Navire,
         vessel_name = Nom.du.navire,
         fishing_zone = Zone.de.pêche,
         fishing_days = Nombres.de.jours.en.mer,
         pefa_gear = Méthode.de.pêche,
         landings = Poids.total.de.poissons.débarqués)
```

And transformed a few columns:

```{r}

pefa <- pefa %>% 
  mutate(across(where(is.character), str_trim)) %>% #Remove all trailing and leading whitespace
  mutate(external_marking = str_remove_all(external_marking, c("\\\"|\\\r|\\\n|\\*|/UFA| ?|-?")), #Remove these patterns
         external_marking = str_replace(external_marking, "^([a-zA-Z]+)(0|-)([0-9]+)$", "\\1\\3"), #Further clean external_marking
         vessel_name = str_to_upper(str_replace(vessel_name, "-", " ")),
         vessel_name = str_remove_all(vessel_name, c("MP ")), #Remove these patterns
         date = as.Date(date, origin = "1899-12-30"),
         landings = as.numeric(gsub("[^0-9]", "", landings))) %>%
  filter(date > "2020-05-01") %>%
  with_groups(c(external_marking, vessel_name, date, pefa_gear, fishing_days), summarise, landings = sum(landings)) %>%
  filter(landings > 0)

```

We then joined EMFF beneficiaries for COVID-19 temporary cessation with PEFA data and cleaned `vessel_name` :

```{r}

# we want to add the fishing gear filled out in PEFA. 
pefa_gear <- emff_covid %>%
  left_join(pefa %>%
              mutate(match = "OK"),
            by = "external_marking") %>% 
  filter(!is.na(match) & date %within% interval(project_start, project_end)) %>%
  group_by(external_marking, pefa_gear) %>% 
  summarise(count =n()) %>% 
  ungroup() %>% 
  group_by(external_marking) %>% 
  filter (count == max(count)) %>% # if a given vessel has used different fishing gear during the TC period, we keep only the gear that was used the most
  slice(1) %>% 
  ungroup () %>%
select (-count)


emff_covid_pefa <- emff_covid %>%
  left_join(pefa %>%
              mutate(match = "OK"),
            by = "external_marking") %>%
  filter(!is.na(match) & date %within% interval(project_start, project_end)) %>% #Keep in-scope records
  select(-c("match", "pefa_gear")) %>%
  left_join(pefa_gear, by="external_marking") %>%
  mutate(comment = ifelse(vessel_name.x == vessel_name.y, "Same name", NA),
         comment = ifelse(is.na(comment) & stringdist(vessel_name.x, vessel_name.y) <= 6, "Spelling mistake", comment),
         source = case_when(external_marking == "ARM44" ~ "ttps://www.shipdata.nl/index.php?mode=shipthumb&Schip=10",
                            external_marking == "ARM7" ~ "https://www.shipdata.nl/index.php?mode=shipthumb&Schip=2",
                            external_marking == "LO28" ~ "https://www.shipdata.nl/index.php?mode=shipthumb&Schip=15822",
                            external_marking == "ST4" ~ "NL vessel from EMFF = https://www.shipdata.nl/index.php?mode=shipthumb&Schip=17268",
                            external_marking == "TS2" ~ "NL vessel from EMFF = https://www.shipdata.nl/index.php?mode=shipthumb&Schip=15791",
                            external_marking == "TX1" ~ "https://www.shipdata.nl/index.php?mode=shipthumb&Schip=12232",
                            external_marking == "TX21" ~ "https://www.shipdata.nl/index.php?mode=shipthumb&Schip=17645",
                            external_marking == "TX3" ~ "https://zoeken-mijn.s-bb.nl/Home/Details?leerbedrijfId=100373808",
                            external_marking == "WR18" ~ "https://www.shipdata.nl/index.php?mode=shipthumb&Schip=521",
                            external_marking == "WR22" ~ "https://www.shipdata.nl/index.php?mode=shipthumb&Schip=15783",
                            external_marking == "WR23" ~ "https://www.shipdata.nl/index.php?mode=shipthumb&Schip=10946",
                            external_marking == "UK171" ~ "https://www.shipdata.nl/index.php?mode=shipthumb&Schip=18821",
                            external_marking == "TX33" ~ "Old vessel name = https://www.shipdata.nl/index.php?mode=shipthumb&Schip=12696",
                            external_marking == "UK225" ~ "Old vessel name = https://www.shipdata.nl/index.php?mode=shipthumb&Schip=87",
                            external_marking == "HD32" ~ "https://www.shipdata.nl/index.php?mode=shipthumb&Schip=18307"),
         comment = ifelse(grepl("[a-zA-Z]+", source) & !grepl("NL vessel", source) & !grepl("Old vessel name", source), "Matching owner", 
                          ifelse(grepl("NL vessel", source), "Incorrect match", 
                                 ifelse(grepl("Old vessel name", source), "Matching old vessel name", comment))),
         source = ifelse(comment %in% c("Same name", "Spelling mistake"), "-", source)) %>%
  rename(vessel_name = vessel_name.x) %>%
  select(-vessel_name.y, - culprit_ais_off, -ais_off_perc, -culprit_7days_gfw) %>%
  filter(!(is.na(comment) | comment == "Incorrect match")) %>%
  group_by(external_marking, date) %>% # for 6 external_marking/date combinations, we have duplicated lines because there are different numbers of fishing days. In these cases, we calculate the sum of landings, and keep only the maximum number of days spent at sea.
  mutate(landings = sum(landings),
         fishing_days = max(fishing_days)) %>%
  ungroup () %>%
  distinct ()

rm(pefa_gear)
```

At this step, `r emff_covid_pefa %>% select(external_marking) %>% distinct() %>% nrow ()` out of the `r emff_covid %>% select(external_marking) %>% nrow ()` vessels that received subsidies for temporary cessation landed at least once in PEFA. 

For these vessels, we estimate the number of full weeks (i.e. 7 consecutive days) spent without fishing based on the landing dates and the number of fishing days filled out in PEFA, for the whole temporary cessation period. It allows to determine if the vessels that landed in PEFA effectively stayed at the port during the number of weeks they were subsidized. Compare to GFW data, this is a complementary approach based on independent data to determine if subsidized vessels have respected the TC rules. 

```{r}

# cessation_begin contains the number of days spent without fishing between the beginning of the project and the first fishing period 

cessation_begin <- emff_covid_pefa %>% 
  arrange(external_marking,date) %>%
  group_by(external_marking) %>%
  slice(1) %>% # we select the first landing date for each vessel
  ungroup () %>%
  mutate(fishing_start = date - fishing_days) %>% # we take into account the number of days at sea before the first landing date to determine when fishing began. 
  mutate(cessation_days = fishing_start - project_start) %>%
  mutate(cessation_days = ifelse(cessation_days < 0, 0, cessation_days)) %>% # sometimes vessels were fishing at the starting date of the project, hence cessation_days is negative and we consider that the number of days without fishing is equal to zero.  
  select(external_marking, cessation_days)
  

# cessation_end contains the number of days spent without fishing between the end of the project and the last fishing period 

cessation_end <- emff_covid_pefa %>% 
  arrange(external_marking, desc(date)) %>% # we select the last landing date for each vessel 
  group_by(external_marking) %>%
  slice(1) %>%
  ungroup () %>%
  mutate(cessation_days = as.numeric(project_end - date + 1)) %>% # we calculate the number of days without fishing between the last fishing period and and the end of the project. We add 1 to take into account the ending day of the TC period.
  select(external_marking, cessation_days)

# culprits_real contains the list of the culprit vessels based on this semi-conservative method that take into account the number of days during which vessel were fishing

emff_covid <- emff_covid %>%
  left_join(emff_covid_pefa %>% 
              select(external_marking, date, fishing_days) %>% 
              arrange(external_marking, date) %>% 
              mutate(fishing_period = interval(date - fishing_days, date - 1)) %>% # fishing period corresponds to the interval of time during which vessels were fishing during temporary cessation. We consider the landing day not to be a fishing day. 
              mutate (cessation_days = as.numeric(as.Date(int_start(lead(fishing_period))) - as.Date(int_end(fishing_period))) - 1) %>% # we calculate between each successive fishing period the number of days spent without fishing. 
              mutate (cessation_days = ifelse(cessation_days <0, 0, cessation_days)) %>% # some fishing periods overlaps, hence the number of days spent without fishing is obviously equal to zero. 
              group_by(external_marking) %>%
              slice(-n()) %>% # we remove the last row because for n fishing periods, there is n-1 period of time without fishing
              ungroup () %>% 
              select(external_marking, cessation_days) %>%
              bind_rows (cessation_begin) %>% # we add the the number of days spent without fishing between the beginning of the project and the first fishing period 
              bind_rows (cessation_end) %>% # we add the number of days spent without fishing between the last fishing period and the end of the project
              arrange(external_marking) %>%
              mutate(cessation_weeks = floor(cessation_days/7)) %>% # we convert days into weeks. As we are only interest by full weeks (i.e., 7 consecutive days), we round to the lower integer. 
              group_by(external_marking) %>% 
              summarise(cessation_weeks = sum(cessation_weeks)) %>% # we calculate the sum of full weeks spent without fishing. 
              ungroup (), by = "external_marking") %>% # we merge these data with the full list of beneficiaries (emff_covid) to compare the number of week subsidized (i.e. hence the number of weeks during which a given vessel have to stay at the port) with the number of weeks effectively spent by the vessel without fishing. 
  mutate (culprit_7days_pefa = ifelse(cessation_weeks < week_subsidy, "TRUE", "UNKNOWN")) %>%# we create a new column indicating if the vessels that landed in PEFA stopped their fishing activity following TC rules. 
  select(-cessation_weeks)

rm(cessation_begin, cessation_end)

```

Based on PEFA data, we found `r emff_covid %>% filter (culprit_7days_pefa == "TRUE") %>% nrow ()` culprit vessels that did not respect the "no fishing during 7 consecutive days per week subsidized" rule. Among those vessels, `r emff_covid %>% filter (culprit_7days_pefa == "TRUE" & culprit_7days_gfw == "UNKNOWN") %>% nrow ()` additional vessels were identified as culprit (they belonged to the "unknown" group based on GFW data), `r emff_covid %>% filter (culprit_7days_pefa == "TRUE" & culprit_7days_gfw == "TRUE") %>% nrow ()` vessels were already identified as culprit based on GFW data, and `r emff_covid %>% filter (culprit_7days_pefa == "TRUE" & culprit_7days_gfw == "FALSE") %>% nrow ()` vessels (UK145 and G023) were identified as culprit based on PEFA data but not culprit based on GFW data (there is a conflict between PEFA and GFW data for these vessels).

Taking into account both GFW and PEFA data, we determine if a vessel respected the "no fishing during 7 consecutive days per week subsidized" rule. We create three categories : the vessels that did not respect the rule, the vessels that did respect the rule, and the vessels for which we don't know based on our data. 

```{r}

culprit <- emff_covid %>% 
  filter ((culprit_ais_off == "TRUE" & culprit_7days_gfw == "UNKNOWN" & culprit_7days_pefa == "TRUE") | 
          (culprit_ais_off == "TRUE" & culprit_7days_gfw == "TRUE" & culprit_7days_pefa == "UNKNOWN") |
          (culprit_ais_off == "TRUE" & culprit_7days_gfw == "TRUE" & is.na(culprit_7days_pefa)) |
          (culprit_ais_off == "FALSE" & culprit_7days_gfw == "TRUE" & is.na(culprit_7days_pefa)) |
          (culprit_ais_off == "FALSE" & culprit_7days_gfw == "TRUE" & culprit_7days_pefa == "UNKNOWN") |
          (culprit_ais_off == "TRUE" & culprit_7days_gfw == "TRUE" & culprit_7days_pefa == "TRUE")) %>% 
  select (external_marking) 

```


```{r}

not_culprit <- emff_covid %>% 
  filter ((culprit_ais_off == "TRUE" & culprit_7days_gfw == "FALSE" & is.na(culprit_7days_pefa)) | 
          (culprit_ais_off == "FALSE" & culprit_7days_gfw == "FALSE" & culprit_7days_pefa == "UNKNOWN") |
          (culprit_ais_off == "FALSE" & culprit_7days_gfw == "FALSE" & is.na(culprit_7days_pefa)) |
          (culprit_ais_off == "TRUE" & culprit_7days_gfw == "FALSE" & culprit_7days_pefa == "UNKNOWN")) %>% 
  select (external_marking) 

```


```{r}

we_dont_know <- emff_covid %>% 
  filter ((culprit_ais_off == "TRUE" & culprit_7days_gfw == "UNKNOWN" & culprit_7days_pefa == "UNKNOWN") | 
          (is.na(culprit_ais_off) & is.na(culprit_7days_gfw) & is.na(culprit_7days_pefa)) |
          (culprit_ais_off == "TRUE" & culprit_7days_gfw == "UNKNOWN" & is.na(culprit_7days_pefa)) |
          (culprit_ais_off == "TRUE" & culprit_7days_gfw == "FALSE" & culprit_7days_pefa == "TRUE") | # conflict between PEFA and GFW data
          (is.na(culprit_ais_off) & is.na(culprit_7days_gfw) & culprit_7days_pefa == "UNKNOWN")) %>% 
  select (external_marking) 

```

We create a new column indicating whether the vessels have respected the "no fishing during 7 consecutive days per week subsidized" rule based on the GFW and PEFA dataset. 

```{r}

emff_covid <- emff_covid %>%
  left_join(culprit %>%
              mutate(culprit_7days_gfw_pefa = "TRUE") %>%
              bind_rows(not_culprit %>%
              mutate(culprit_7days_gfw_pefa = "FALSE")) %>%
              bind_rows(we_dont_know %>%
              mutate(culprit_7days_gfw_pefa = "UNKNOWN")), by = "external_marking")

rm(culprit, not_culprit, we_dont_know)

```

### Summary of the results 

Out of the `r emff_covid %>% filter (!is.na(culprit_ais_off)) %>% nrow()` subsidized and identified vessels, only `r emff_covid %>% filter (culprit_ais_off == "FALSE" & culprit_7days_gfw_pefa == "FALSE") %>% nrow()` vessels have remained within the framework of the law by having respected i) the obligation to keep the AIS on over the entire period covered by the temporary shutdowns and ii) to stop any fishing activities during 7 consecutive days per week subsidized. These vessels received `r format(emff_covid %>% filter (culprit_ais_off == "FALSE" & culprit_7days_gfw_pefa == "FALSE") %>% ungroup () %>% summarise (sum(subsidy_total)) %>% pull (), big.mark = ",")` euros out of the `r format(emff_covid %>% ungroup () %>% summarise (sum(subsidy_total)) %>% pull (), big.mark = ",")` euros allocated to temporary cessations. `r emff_covid %>% filter (culprit_ais_off == "FALSE" & culprit_7days_gfw_pefa == "TRUE") %>% nrow()` vessels respected the obligation to keep the AIS on but did not stop their fishing activities during 7 consecutive days per week subsidized. 

`r emff_covid %>% filter (culprit_ais_off == "TRUE") %>% nrow()` vessels switched at least once their AIS. Among them, `r emff_covid %>% filter (culprit_ais_off == "TRUE" & culprit_7days_gfw_pefa == "FALSE") %>% nrow()` stopped their fishing activities during 7 consecutive days per week subsidized. `r emff_covid %>% filter (culprit_ais_off == "TRUE" & culprit_7days_gfw_pefa == "TRUE") %>% nrow()` did not stop their fishing activities during 7 consecutive days per week subsidized. This was highlighted thanks to GFW and/or PEFA data. And for `r emff_covid %>% filter (culprit_ais_off == "TRUE" & culprit_7days_gfw_pefa == "UNKNOWN") %>% nrow()` vessels, we cannot conclude whether they stopped their fishing activities or not. 

The following table shows the `r emff_covid %>% filter (culprit_ais_off == "FALSE" & culprit_7days_gfw_pefa == "FALSE") %>% nrow()` vessels that have remained within the framework of the law by having respected i) the obligation to keep the AIS on over the entire period covered by the temporary shutdowns and ii) to stop any fishing activities during 7 consecutive days per week subsidized.

```{r, echo=FALSE}
table(emff_covid %>% 
        filter (culprit_ais_off == "FALSE" & culprit_7days_gfw_pefa == "FALSE") %>% 
        arrange(external_marking) %>%
        select("External marking" = external_marking, "Vessel name" = vessel_name,"CFR" = cfr, "Number of weeks subsidized" = week_subsidy, "Amount of subsidy (EUR)" = subsidy_total,"Fishing gear" = gear, "Length (m)" = length, "Fraction of time spent with AIS off" = ais_off_perc), "Vessels that remained within the framework of the law")
```

The following table shows the `r emff_covid %>% filter (culprit_ais_off == "FALSE" & culprit_7days_gfw_pefa == "TRUE") %>% nrow()` vessels that have respected the obligation to keep the AIS on but did not stop their fishing activities during 7 consecutive days per week subsidized. 

```{r, echo=FALSE}

table(emff_covid %>% 
  filter (culprit_ais_off == "FALSE" & culprit_7days_gfw_pefa == "TRUE") %>%
  arrange(external_marking) %>%
  select("External marking" = external_marking, "Vessel name" = vessel_name,"CFR" = cfr, "Number of weeks subsidized" = week_subsidy, "Amount of subsidy (EUR)" = subsidy_total,"Fishing gear" = gear, "Length (m)" = length, "Fraction of time spent with AIS off" = ais_off_perc), "Vessels that have respected the obligation to keep the AIS on but did not stop their fishing activities during 7 consecutive days per week subsidized")
  
```

The following table shows the `r emff_covid %>% filter (culprit_ais_off == "TRUE" & culprit_7days_gfw_pefa == "FALSE") %>% nrow()` vessels that switched off their AIS but were able to prove they have stopped their fishing activities for seven consecutive days per week subsidized. 

```{r, echo=FALSE}

table(emff_covid %>% 
  filter (culprit_ais_off == "TRUE" & culprit_7days_gfw_pefa == "FALSE") %>%
  arrange(external_marking) %>%
  select("External marking" = external_marking, "Vessel name" = vessel_name,"CFR" = cfr, "Number of weeks subsidized" = week_subsidy, "Amount of subsidy (EUR)" = subsidy_total,"Fishing gear" = gear, "Length (m)" = length, "Fraction of time spent with AIS off" = ais_off_perc), "Vessels that switched off their AIS but were able to prove they have stopped their fishing activities for seven consecutive days per week subsidized")

```

The following table shows the `r emff_covid %>% filter (culprit_ais_off == "TRUE" & culprit_7days_gfw_pefa == "TRUE") %>% nrow()` vessels that switched off their AIS and did not stop their fishing activities during 7 consecutive days per week subsidized. 

```{r, echo=FALSE}

table(emff_covid %>% 
  filter (culprit_ais_off == "TRUE" & culprit_7days_gfw_pefa == "TRUE") %>%
  arrange(external_marking) %>%
  select("External marking" = external_marking, "Vessel name" = vessel_name,"CFR" = cfr, "Number of weeks subsidized" = week_subsidy, "Amount of subsidy (EUR)" = subsidy_total,"Fishing gear" = gear, "Length (m)" = length, "Fraction of time spent with AIS off" = ais_off_perc), "Vessels that switched off their AIS and did not stop their fishing activities during 7 consecutive days per week subsidized")
  
```

The following table shows the `r emff_covid %>% filter (culprit_ais_off == "TRUE" & culprit_7days_gfw_pefa == "UNKNOWN") %>% nrow()` vessels that switched off their AIS but for which we cannot conclude whether they stopped their fishing activities or not. 
 
```{r, echo=FALSE}

table(emff_covid %>% 
  filter (culprit_ais_off == "TRUE" & culprit_7days_gfw_pefa == "UNKNOWN") %>%
  arrange(external_marking) %>%
  select("External marking" = external_marking, "Vessel name" = vessel_name,"CFR" = cfr, "Number of weeks subsidized" = week_subsidy, "Amount of subsidy (EUR)" = subsidy_total,"Fishing gear" = gear, "Length (m)" = length, "Fraction of time spent with AIS off" = ais_off_perc), "Vessels that switched off their AIS but for which we cannot conclude whether they stopped their fishing activities or not")

```
 
### Bar codes 

Bar codes are created to represent the activity (fishing days according to both PEFA and GFW, days when the AIS was switched off, landing days in PEFA auctions) of each of the `r nrow(emff_covid)` vessels that were subsidized. Plots are located in Output/Figures/Barcodes/. 

The black unfilled rectangle indicates the temporary cessation period. The red vertical lines indicate the landing dates in PEFA auctions. The black bars correspond to the fishing days on GFW. The grey bars correspond to days when AIS was switched off on GFW. The blue horizontal lines ontop of each bar codes indicate the fishing periods indicated in PEFA.


```{r, echo=FALSE, warning=FALSE}

data_fig <- read.xlsx("Data/Processed/GFW_data.xlsx") %>% 
          mutate_at(vars(c("project_start", "project_end", "fishing_start_gfw", "fishing_end_gfw", "ais_off_begin_gfw", "ais_off_end_gfw")), ~as.Date(., origin = "1899-12-30")) %>%
          select (-data_acquisition, -access, -cfr, -mmsi, -vessel_name, -last_check) %>% 
  filter (external_marking %in% c(emff_covid %>% select (external_marking) %>% pull ())) %>% 
  bind_rows (emff_covid_pefa %>% 
               mutate(fishing_days = ifelse(fishing_days == 0, 1, fishing_days)) %>% # if there is a landing, there is at least one fishing day
               mutate (fishing_start_pefa = date - fishing_days, 
                       fishing_end_pefa = date - 1) %>%
               select (external_marking, fishing_start_pefa, fishing_end_pefa, date) %>%
               rename(landing_date = date)) %>%
  arrange(external_marking) %>%
  fill(c("project_start", "project_end"), .direction = "down") %>%
  left_join(emff_covid %>% 
              select(external_marking, vessel_name, cfr, week_subsidy, culprit_ais_off, culprit_7days_gfw_pefa), by = "external_marking") %>%
  mutate (label = paste0(external_marking, " ", vessel_name)) %>%
  relocate(label, .before = "external_marking") %>% 
    select (-external_marking, -vessel_name) %>%
  mutate (group = ifelse(culprit_ais_off == "FALSE" & culprit_7days_gfw_pefa == "FALSE", "ais on_TC not culprit",
                         ifelse(culprit_ais_off == "FALSE" & culprit_7days_gfw_pefa == "TRUE", "ais on_TC culprit",
                                ifelse(culprit_ais_off == "TRUE" & culprit_7days_gfw_pefa == "FALSE", "ais off_ TC not culprit",
                                       ifelse(culprit_ais_off == "TRUE" & culprit_7days_gfw_pefa == "TRUE", "ais off_TC culprit","ais off_TC unknown")))))

for (i in 1:nrow(data_fig %>% select(group) %>% distinct())) { 

dir.create(paste0("Output/Figures/Barcodes/", data_fig %>% select(group) %>% distinct() %>% slice(i) %>% pull ()))
  
data_fig_sub <- data_fig %>% 
    filter(group == data_fig %>% select(group) %>% distinct() %>% slice (i) %>% pull ())

vessel <- data_fig_sub %>% 
  select (label, cfr, week_subsidy) %>% 
  distinct ()

  for (j in 1: nrow(vessel)) { 
  
  FileName <- paste0(vessel[j,1], ".jpg", sep = "") 
  
  ggplot(data_fig_sub %>% 
    filter(label == vessel[j,1])) + 
    geom_rect(aes(xmin = fishing_start_gfw,
                xmax = fishing_end_gfw + 1,
                ymin = 0,
                ymax = 1),
            fill = "grey0") +
    geom_rect(aes(xmin = ais_off_begin_gfw,
                xmax = ais_off_end_gfw + 1,
                ymin = 0,
                ymax = 1),
            fill = "grey70") +
    geom_bar(aes(x=landing_date, y = 1),
             stat = "identity",
             fill = "red",
             width = 1,
             alpha = 0.7,
             position = position_nudge(x = 0.5)) +
    geom_rect(aes(xmin = project_start,
                xmax = project_end + 1,
                ymin = 0,
                ymax = 1),
            color = "grey0",
            fill = NA) + 
    geom_segment(aes(x=fishing_start_pefa, xend=fishing_end_pefa +1, y=1.03, yend=1.03), 
                 size =4, colour = "#49667D") +
    theme_light () %+%
    theme(axis.line.y = element_blank(),
                       axis.text.y = element_blank(),
                       axis.ticks.y = element_blank()) + 
    labs(x=NULL, y = NULL, title = paste0(vessel[j,1], " (", vessel[j,2],")", " - Nombre de semaines subventionnées = ", vessel[j,3])) +
    scale_x_date (date_breaks = "1 month", date_labels = "%b %d",date_minor_breaks = "1 day") 

  ggsave (FileName, plot = last_plot(), path = paste0("Output/Figures/Barcodes/",data_fig %>% select(group) %>% distinct() %>% slice(i) %>% pull ()), width = 30, height = 15, unit = "cm") 
  } 
}

```
